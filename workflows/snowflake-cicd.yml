name: Snowflake Deployment

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v3

    - name: Install SnowSQL
      run: |
        sudo apt-get update
        sudo apt-get install -y snowsql

    - name: Configure SnowSQL
      run: |
        mkdir -p ~/.snowsql
        cat <<EOF > ~/.snowsql/config
        [connections.deploy]
        accountname = ${{ secrets.SF_ACCOUNT }}
        username = ${{ secrets.SF_USER }}
        password = ${{ secrets.SF_PASSWORD }}
        warehousename = COMPUTE_WH
        dbname = DEMO_DB
        schemaname = PUBLIC
        role = ACCOUNTADMIN
        EOF

    - name: Deploy SQL Files
      run: |
        for file in sql/*.sql; do
          snowsql -c deploy -f "$file"
        done
